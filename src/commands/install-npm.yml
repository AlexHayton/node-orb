description: >
  Install/upgrade the NPM package manager. Requires an existing
  installation of Node.js; if none exists, use the orb's `install`
  command instead.

parameters:
  npm-version:
    type: string
    default: latest
    description: >
      Pick a version of NPM to install:
      https://nodejs.org/en/download/releases
      (Note: NPM version selection is not possible on Alpine Linux;
      on Alpine, the `npm` Alpine pkg will be installed:
      https://pkgs.alpinelinux.org/packages?name=npm)

steps:
  - run:
      name: Install NPM
      command: |
        if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi

        if cat /etc/issue | grep Alpine; then

          # https://wiki.alpinelinux.org/wiki/Include:Upgrading_to_Edge
          sed -i -e 's/v[[:digit:]]\.[[:digit:]]/edge/g' /etc/apk/repositories
          apk upgrade --update-cache --available

          apk --no-cache add npm

          echo "Success: NPM $(npm -v) (Alpine APK) has been installed to $(which npm)"
        else
          npm install -g npm@<<parameters.npm-version>>

          # test/verify version
          if npm -v | grep <<parameters.npm-version>>; then
            echo "Success! NPM $(npm -v) has been installed to $(which npm)"
          else
            echo "Something went wrong; the specified version of NPM could not be installed"
          fi
        fi
