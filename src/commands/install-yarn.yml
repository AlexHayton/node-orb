description: >
  Install a custom version of the Yarn package manager

parameters:
  version:
    type: string
    default: ""
    description: >
      Pick a version of Yarn to install (if no version is specified,
      the latest stable version will be installed):
      https://github.com/yarnpkg/yarn/releases

  debug:
    type: boolean
    default: false
    description: >
      Extra output for orb developers

steps:
  - run:
      name: Install Yarn
      command: |
        # FUNCTIONS
        get_yarn_version () {
          if [[ "<<parameters.version>>" == "" ]]; then
            VERSION=$(curl --silent --show-error \
              --location --fail --retry 3 \
              https://api.github.com/repos/yarnpkg/yarn/releases/latest | \
              grep tag_name | cut -d '"' -f 4 | \
              cut -d 'v' -f 2)

            echo "Latest version of Yarn is $VERSION"
          else
            VERSION=<<parameters.version>>

            echo "Selected version of Yarn is $VERSION"
          fi
        }

        installation_check () {
          if command -v yarn<<^parameters.debug>> > /dev/null 2>&1<</parameters.debug>>; then
            if yarn --version | grep "$VERSION"<<^parameters.debug>> > /dev/null 2>&1<</parameters.debug>>; then
              echo "Yarn $VERSION is already installed"
              exit 0
            fi
          fi
        }

        get_yarn_version
        installation_check

        # downloaod install script
        curl -O \
          --silent --show-error --location --fail --retry 3 \
          https://yarnpkg.com/install.sh

        # install yarn
        bash install.sh<<#parameters.version>> -s -- \
          --version <<parameters.version>><</parameters.version>><<^parameters.debug>> > /dev/null 2>&1<</parameters.debug>>

        echo 'export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH:`yarn global bin`"' \
          1>> $BASH_ENV 2> /dev/null

        source $BASH_ENV

        # test/verify version
        if yarn --version | grep "$VERSION"<<^parameters.debug>> > /dev/null 2>&1<</parameters.debug>>; then
          echo "Success! Yarn $(yarn --version) has been installed to $(which yarn)"
        else
          echo "Something went wrong; the specified version of Yarn could not be installed"
          exit 1
        fi
